
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../prophet/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.14">
    
    
      
        <title>Hierarchical Prophet - Hierarchical Prophet</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.10ba22f1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#hierarchicalprophet" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Hierarchical Prophet" class="md-header__button md-logo" aria-label="Hierarchical Prophet" data-md-component="logo">
      
  <img src="../../static/logo-removebg.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hierarchical Prophet
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Hierarchical Prophet
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/felipeangelimvieira/hierarchical_prophet" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Hierarchical Prophet" class="md-nav__button md-logo" aria-label="Hierarchical Prophet" data-md-component="logo">
      
  <img src="../../static/logo-removebg.png" alt="logo">

    </a>
    Hierarchical Prophet
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/felipeangelimvieira/hierarchical_prophet" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/univariate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Univariate timeseries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/hierarchical/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hierarchical timeseries
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prophet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prophet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Hierarchical Prophet
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Hierarchical Prophet
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet" class="md-nav__link">
    <span class="md-ellipsis">
      prophet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet" class="md-nav__link">
    <span class="md-ellipsis">
      HierarchicalProphet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HierarchicalProphet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.n_changepoint_per_series" class="md-nav__link">
    <span class="md-ellipsis">
      n_changepoint_per_series
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.n_series" class="md-nav__link">
    <span class="md-ellipsis">
      n_series
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.get_changepoint_prior_vectors" class="md-nav__link">
    <span class="md-ellipsis">
      get_changepoint_prior_vectors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.predict_samples" class="md-nav__link">
    <span class="md-ellipsis">
      predict_samples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.enforce_array_if_zero_dim" class="md-nav__link">
    <span class="md-ellipsis">
      enforce_array_if_zero_dim
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.model" class="md-nav__link">
    <span class="md-ellipsis">
      model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.to_list_if_scalar" class="md-nav__link">
    <span class="md-ellipsis">
      to_list_if_scalar
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet" class="md-nav__link">
    <span class="md-ellipsis">
      prophet
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet" class="md-nav__link">
    <span class="md-ellipsis">
      HierarchicalProphet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HierarchicalProphet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.n_changepoint_per_series" class="md-nav__link">
    <span class="md-ellipsis">
      n_changepoint_per_series
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.n_series" class="md-nav__link">
    <span class="md-ellipsis">
      n_series
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.get_changepoint_prior_vectors" class="md-nav__link">
    <span class="md-ellipsis">
      get_changepoint_prior_vectors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.predict_samples" class="md-nav__link">
    <span class="md-ellipsis">
      predict_samples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.enforce_array_if_zero_dim" class="md-nav__link">
    <span class="md-ellipsis">
      enforce_array_if_zero_dim
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.model" class="md-nav__link">
    <span class="md-ellipsis">
      model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hierarchical_prophet.hierarchical_prophet.prophet.to_list_if_scalar" class="md-nav__link">
    <span class="md-ellipsis">
      to_list_if_scalar
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="hierarchicalprophet">HierarchicalProphet</h1>


<div class="doc doc-object doc-module">



<a id="hierarchical_prophet.hierarchical_prophet.prophet"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet" class="doc doc-heading">
          <code>HierarchicalProphet</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="hierarchical_prophet.base.BaseBayesianForecaster">BaseBayesianForecaster</span></code></p>

  
      <p>A class that represents a Bayesian hierarchical time series forecasting model based on the Prophet algorithm.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>changepoint_interval</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The interval between potential changepoints in the time series. Defaults to 25.</p>
            </div>
          </td>
          <td>
                <code>25</code>
          </td>
        </tr>
        <tr>
          <td><code>changepoint_range</code></td>
          <td>
                <code>float or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The index of the last changepoint. If None, default to -changepoint_freq. Note that this is the index in the list of timestamps, and because the timeseries increases in size, it is better to use negative indexes instead of positive. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>exogenous_priors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of prior distributions for the exogenous variables. The keys are regexes, or the name of an specific column, and the values are tuples of the format (dist.Distribution, *args). The args are passed to dist.Distributions at the moment of sampling. Defaults to {}.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>default_exogenous_prior</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The default prior distribution for the exogenous variables. Defaults to (dist.Normal, 0, 1), and is applied to columns not included in exogenous_priors above.</p>
            </div>
          </td>
          <td>
                <code>(<span title="numpyro.distributions.Normal">Normal</span>, 0, 1)</code>
          </td>
        </tr>
        <tr>
          <td><code>changepoint_prior_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scale parameter for the prior distribution of changepoints. Defaults to 0.1. Note that this parameter is scaled by the magnitude of the timeseries.</p>
            </div>
          </td>
          <td>
                <code>0.1</code>
          </td>
        </tr>
        <tr>
          <td><code>capacity_prior_loc</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The location parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 1.1, i.e., 110% of the maximum value of the series, or the y_scales if provided.</p>
            </div>
          </td>
          <td>
                <code>1.1</code>
          </td>
        </tr>
        <tr>
          <td><code>capacity_prior_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scale parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 0.2.</p>
            </div>
          </td>
          <td>
                <code>0.2</code>
          </td>
        </tr>
        <tr>
          <td><code>y_scales</code></td>
          <td>
                <code>array - like or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scales of the target time series. Defaults to None. If not provided, the scales are computed from the data, according to its maximum value.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>noise_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scale parameter for the prior distribution of observation noise. Defaults to 0.05.</p>
            </div>
          </td>
          <td>
                <code>0.05</code>
          </td>
        </tr>
        <tr>
          <td><code>trend</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The type of trend to model. Possible values are "linear" and "logistic". Defaults to "linear".</p>
            </div>
          </td>
          <td>
                <code>&#39;linear&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>seasonality_mode</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The mode of seasonality to model. Possible values are "multiplicative" and "additive". Defaults to "multiplicative".</p>
            </div>
          </td>
          <td>
                <code>&#39;multiplicative&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>transformer_pipeline</code></td>
          <td>
                <code><span title="sktime.transformations.base.BaseTransformer">BaseTransformer</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A BaseTransformer or TransformerPipeline from sktime to apply to X and create features internally, such as Fourier series. See sktime's Transformer documentation for more information. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>individual_regressors</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of regexes/names of individual regressors to separate by timeseries. If not provided, all regressors are shared. Defaults to [].</p>
            </div>
          </td>
          <td>
                <code>[]</code>
          </td>
        </tr>
        <tr>
          <td><code>mcmc_samples</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of MCMC samples to draw. Defaults to 2000.</p>
            </div>
          </td>
          <td>
                <code>2000</code>
          </td>
        </tr>
        <tr>
          <td><code>mcmc_warmup</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of MCMC warmup steps. Defaults to 200.</p>
            </div>
          </td>
          <td>
                <code>200</code>
          </td>
        </tr>
        <tr>
          <td><code>mcmc_chains</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of MCMC chains to run in parallel. Defaults to 4.</p>
            </div>
          </td>
          <td>
                <code>4</code>
          </td>
        </tr>
        <tr>
          <td><code>rng_key</code></td>
          <td>
                <code><span title="jax.random.PRNGKey">PRNGKey</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The random number generator key. Defaults to random.PRNGKey(24).</p>
            </div>
          </td>
          <td>
                <code><span title="jax.random.PRNGKey">PRNGKey</span>(24)</code>
          </td>
        </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">HierarchicalProphet</span><span class="p">(</span><span class="n">BaseBayesianForecaster</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A class that represents a Bayesian hierarchical time series forecasting model based on the Prophet algorithm.</span>

<span class="sd">    Args:</span>
<span class="sd">        changepoint_interval (int, optional): The interval between potential changepoints in the time series. Defaults to 25.</span>
<span class="sd">        changepoint_range (float or None, optional): The index of the last changepoint. If None, default to -changepoint_freq. Note that this is the index in the list of timestamps, and because the timeseries increases in size, it is better to use negative indexes instead of positive. Defaults to None.</span>
<span class="sd">        exogenous_priors (dict, optional): A dictionary of prior distributions for the exogenous variables. The keys are regexes, or the name of an specific column, and the values are tuples of the format (dist.Distribution, *args). The args are passed to dist.Distributions at the moment of sampling. Defaults to {}.</span>
<span class="sd">        default_exogenous_prior (tuple, optional): The default prior distribution for the exogenous variables. Defaults to (dist.Normal, 0, 1), and is applied to columns not included in exogenous_priors above.</span>
<span class="sd">        changepoint_prior_scale (float, optional): The scale parameter for the prior distribution of changepoints. Defaults to 0.1. Note that this parameter is scaled by the magnitude of the timeseries.</span>
<span class="sd">        capacity_prior_loc (float, optional): The location parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 1.1, i.e., 110% of the maximum value of the series, or the y_scales if provided.</span>
<span class="sd">        capacity_prior_scale (float, optional): The scale parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 0.2.</span>
<span class="sd">        y_scales (array-like or None, optional): The scales of the target time series. Defaults to None. If not provided, the scales are computed from the data, according to its maximum value.</span>
<span class="sd">        noise_scale (float, optional): The scale parameter for the prior distribution of observation noise. Defaults to 0.05.</span>
<span class="sd">        trend (str, optional): The type of trend to model. Possible values are &quot;linear&quot; and &quot;logistic&quot;. Defaults to &quot;linear&quot;.</span>
<span class="sd">        seasonality_mode (str, optional): The mode of seasonality to model. Possible values are &quot;multiplicative&quot; and &quot;additive&quot;. Defaults to &quot;multiplicative&quot;.</span>
<span class="sd">        transformer_pipeline (BaseTransformer): A BaseTransformer or TransformerPipeline from sktime to apply to X and create features internally, such as Fourier series. See sktime&#39;s Transformer documentation for more information. Defaults to None.</span>
<span class="sd">        individual_regressors (list, optional): A list of regexes/names of individual regressors to separate by timeseries. If not provided, all regressors are shared. Defaults to [].</span>
<span class="sd">        mcmc_samples (int, optional): The number of MCMC samples to draw. Defaults to 2000.</span>
<span class="sd">        mcmc_warmup (int, optional): The number of MCMC warmup steps. Defaults to 200.</span>
<span class="sd">        mcmc_chains (int, optional): The number of MCMC chains to run in parallel. Defaults to 4.</span>
<span class="sd">        rng_key (jax.random.PRNGKey, optional): The random number generator key. Defaults to random.PRNGKey(24).</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_tags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;scitype:y&quot;</span><span class="p">:</span> <span class="s2">&quot;univariate&quot;</span><span class="p">,</span>  <span class="c1"># which y are fine? univariate/multivariate/both</span>
        <span class="s2">&quot;ignores-exogeneous-X&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># does estimator ignore the exogeneous X?</span>
        <span class="s2">&quot;handles-missing-data&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># can estimator handle missing data?</span>
        <span class="s2">&quot;y_inner_mtype&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;pd.Series&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pd_multiindex_hier&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pd-multiindex&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;X_inner_mtype&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;pd_multiindex_hier&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pd-multiindex&quot;</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># which types do _fit, _predict, assume for X?</span>
        <span class="s2">&quot;requires-fh-in-fit&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># is forecasting horizon already required in fit?</span>
        <span class="s2">&quot;X-y-must-have-same-index&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># can estimator handle different X/y index?</span>
        <span class="s2">&quot;enforce_index_type&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># index type that needs to be enforced in X/y</span>
        <span class="s2">&quot;capability:pred_int&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># does forecaster implement proba forecasts?</span>
        <span class="s2">&quot;fit_is_empty&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;capability:pred_int&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;capability:pred_int:insample&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">changepoint_interval</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">changepoint_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exogenous_priors</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">default_exogenous_prior</span><span class="o">=</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">changepoint_prior_scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">capacity_prior_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">capacity_prior_loc</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
        <span class="n">y_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">noise_scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="n">seasonality_mode</span><span class="o">=</span><span class="s2">&quot;multiplicative&quot;</span><span class="p">,</span>
        <span class="n">transformer_pipeline</span><span class="p">:</span> <span class="n">BaseTransformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">individual_regressors</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">mcmc_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">mcmc_warmup</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">mcmc_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the HierarchicalProphet forecaster.</span>

<span class="sd">        Args:</span>
<span class="sd">            changepoint_interval (int, optional): The interval between potential changepoints in the time series. Defaults to 25.</span>
<span class="sd">            changepoint_range (float or None, optional): The index of the last changepoint. If None, default to -changepoint_freq. Note that this is the index in the list of timestamps, and because the timeseries increases in size, it is better to use negative indexes instead of positive. Defaults to None.</span>
<span class="sd">            exogenous_priors (dict, optional): A dictionary of prior distributions for the exogenous variables. The keys are regexes, or the name of an specific column, and the values are tuples of the format (dist.Distribution, *args). The args are passed to dist.Distributions at the moment of sampling. Defaults to {}.</span>
<span class="sd">            default_exogenous_prior (tuple, optional): The default prior distribution for the exogenous variables. Defaults to (dist.Normal, 0, 1), and is applied to columns not included in exogenous_priors above.</span>
<span class="sd">            changepoint_prior_scale (float, optional): The scale parameter for the prior distribution of changepoints. Defaults to 0.1. Note that this parameter is scaled by the magnitude of the timeseries.</span>
<span class="sd">            capacity_prior_loc (float, optional): The location parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 1.1, i.e., 110% of the maximum value of the series, or the y_scales if provided.</span>
<span class="sd">            capacity_prior_scale (float, optional): The scale parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 0.2.</span>
<span class="sd">            y_scales (array-like or None, optional): The scales of the target time series. Defaults to None. If not provided, the scales are computed from the data, according to its maximum value.</span>
<span class="sd">            noise_scale (float, optional): The scale parameter for the prior distribution of observation noise. Defaults to 0.05.</span>
<span class="sd">            trend (str, optional): The type of trend to model. Possible values are &quot;linear&quot; and &quot;logistic&quot;. Defaults to &quot;linear&quot;.</span>
<span class="sd">            seasonality_mode (str, optional): The mode of seasonality to model. Possible values are &quot;multiplicative&quot; and &quot;additive&quot;. Defaults to &quot;multiplicative&quot;.</span>
<span class="sd">            transformer_pipeline (BaseTransformer): A BaseTransformer or TransformerPipeline from sktime to apply to X and create features internally, such as Fourier series. See sktime&#39;s Transformer documentation for more information. Defaults to None.</span>
<span class="sd">            individual_regressors (list, optional): A list of regexes/names of individual regressors to separate by timeseries. If not provided, all regressors are shared. Defaults to [].</span>
<span class="sd">            mcmc_samples (int, optional): The number of MCMC samples to draw. Defaults to 2000.</span>
<span class="sd">            mcmc_warmup (int, optional): The number of MCMC warmup steps. Defaults to 200.</span>
<span class="sd">            mcmc_chains (int, optional): The number of MCMC chains to run in parallel. Defaults to 4.</span>
<span class="sd">            rng_key (jax.random.PRNGKey, optional): The random number generator key. Defaults to random.PRNGKey(24).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_interval</span> <span class="o">=</span> <span class="n">changepoint_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_range</span> <span class="o">=</span> <span class="n">changepoint_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_prior_scale</span> <span class="o">=</span> <span class="n">changepoint_prior_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_scale</span> <span class="o">=</span> <span class="n">noise_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_scale</span> <span class="o">=</span> <span class="n">capacity_prior_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_loc</span> <span class="o">=</span> <span class="n">capacity_prior_loc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span> <span class="o">=</span> <span class="n">y_scales</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seasonality_mode</span> <span class="o">=</span> <span class="n">seasonality_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="n">trend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exogenous_priors</span> <span class="o">=</span> <span class="n">exogenous_priors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_exogenous_prior</span> <span class="o">=</span> <span class="n">default_exogenous_prior</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">individual_regressors</span> <span class="o">=</span> <span class="n">individual_regressors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span> <span class="o">=</span> <span class="n">transformer_pipeline</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;mcmc&quot;</span><span class="p">,</span>
            <span class="n">mcmc_samples</span><span class="o">=</span><span class="n">mcmc_samples</span><span class="p">,</span>
            <span class="n">mcmc_warmup</span><span class="o">=</span><span class="n">mcmc_warmup</span><span class="p">,</span>
            <span class="n">mcmc_chains</span><span class="o">=</span><span class="n">mcmc_chains</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_y_indexes_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_y_indexes_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand_columns_transformer_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_hyperparams</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_validate_hyperparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate the hyperparameters of the HierarchicalProphet forecaster.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;changepoint_interval must be greater than 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changepoint_range</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_range</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;changepoint_range must be in the range (0, 1].&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_prior_scale</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;changepoint_prior_scale must be greater than 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_scale</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;noise_scale must be greater than 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_scale</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;capacity_prior_scale must be greater than 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_loc</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;capacity_prior_loc must be greater than 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">scale</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">scale</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;y_scales must be greater than 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasonality_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;multiplicative&quot;</span><span class="p">,</span> <span class="s2">&quot;additive&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;seasonality_mode must be either &quot;multiplicative&quot; or &quot;additive&quot;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="s2">&quot;logistic&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;trend must be either &quot;linear&quot; or &quot;logistic&quot;.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;y_scales must have the same length as the number of columns in y.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_numpyro_model_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">fh</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the data for the NumPyro model.</span>

<span class="sd">        Args:</span>
<span class="sd">            y (pd.DataFrame): Training target time series.</span>
<span class="sd">            X (pd.DataFrame): Training exogenous variables.</span>
<span class="sd">            fh (ForecastingHorizon): Forecasting horizon.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary containing the model data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_hyperparams</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># Handling series without __total indexes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_</span> <span class="o">=</span> <span class="n">Aggregator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_y_indexes_</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">index</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_y_indexes_</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># Hierarchy matrix (S Matrix)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy_matrix</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_get_s_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># Updating internal _y of sktime because BaseBayesianForecaster uses it to convert</span>
        <span class="c1"># Forecast Horizon into multiindex correcly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">y</span>

        <span class="c1"># If no exogenous variables, create empty DataFrame</span>
        <span class="c1"># Else, aggregate exogenous variables and transform them</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>

            <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">y_bottom</span> <span class="o">=</span> <span class="n">loc_bottom_series</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># Convert inputs to array, including the time index</span>
        <span class="n">y_arrays</span> <span class="o">=</span> <span class="n">series_to_tensor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_bottom_arrays</span> <span class="o">=</span> <span class="n">series_to_tensor</span><span class="p">(</span><span class="n">y_bottom</span><span class="p">)</span>
        <span class="n">t_arrays</span> <span class="o">=</span> <span class="n">extract_timetensor_from_dataframe</span><span class="p">(</span><span class="n">y_bottom</span><span class="p">)</span>

        <span class="c1"># Setup model parameters and scalers, and get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_scales</span><span class="p">(</span><span class="n">t_arrays</span><span class="p">,</span> <span class="n">y_bottom_arrays</span><span class="p">)</span>

        <span class="n">t_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">t_arrays</span><span class="p">)</span>

        <span class="c1"># Changepoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_changepoint_matrix_transformer</span><span class="p">(</span><span class="n">t_scaled</span><span class="p">)</span>
        <span class="n">changepoints_matrix</span><span class="p">,</span> <span class="n">changepoints_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_scaled</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Exog variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exogenous_columns_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">expand_columns_transformer_</span> <span class="o">=</span> <span class="n">ExpandColumnPerLevel</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">individual_regressors</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_columns_transformer_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">exogenous_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exogenous_matrix_from_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exogenous_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">exogenous_matrix</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t_scaled</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extra_inputs_</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;s_matrix&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy_matrix</span><span class="p">,</span>
            <span class="s2">&quot;changepoints_matrix&quot;</span><span class="p">:</span> <span class="n">changepoints_matrix</span><span class="p">,</span>
            <span class="s2">&quot;changepoints_mask&quot;</span><span class="p">:</span> <span class="n">changepoints_mask</span><span class="p">,</span>
            <span class="s2">&quot;y_scales&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span><span class="p">,</span>
            <span class="s2">&quot;seasonality_mode&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasonality_mode</span><span class="p">,</span>
            <span class="s2">&quot;trend_mode&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_prior_distributions</span><span class="p">(</span><span class="n">t_scaled</span><span class="p">,</span> <span class="n">y_bottom_arrays</span><span class="p">,</span> <span class="n">X</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">t</span><span class="o">=</span><span class="n">t_scaled</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_arrays</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">exogenous_matrix</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_inputs_</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_exogenous_matrix_from_X</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the exogenous variables to a NumPyro matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (pd.DataFrame): The exogenous variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            jnp.ndarray: The NumPyro matrix of the exogenous variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X_bottom</span> <span class="o">=</span> <span class="n">loc_bottom_series</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X_arrays</span> <span class="o">=</span> <span class="n">series_to_tensor</span><span class="p">(</span><span class="n">X_bottom</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X_arrays</span>

    <span class="k">def</span> <span class="nf">_setup_scales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_arrays</span><span class="p">,</span> <span class="n">y_arrays</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup model parameters and scalers.</span>

<span class="sd">        Args:</span>
<span class="sd">            t_arrays (ndarray): Transformed time index.</span>
<span class="sd">            y_arrays (ndarray): Transformed target time series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># Scale time index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span> <span class="o">=</span> <span class="n">TimeScaler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_arrays</span><span class="p">)</span>
        <span class="n">t_scaled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_arrays</span><span class="p">)</span>

        <span class="c1"># Setting loc and scales for the priors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="n">y_arrays</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="o">=</span> <span class="n">y_arrays</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_t</span> <span class="o">=</span> <span class="n">t_scaled</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_t</span> <span class="o">=</span> <span class="n">t_scaled</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_capacity_prior_loc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The prior location of the capacity parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The prior location of the capacity parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_loc</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_series</span><span class="p">)</span> <span class="o">*</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_capacity_prior_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_scale</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_series</span><span class="p">)</span> <span class="o">*</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_setup_changepoint_matrix_transformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_scaled</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup changepoint variables and transformer.</span>

<span class="sd">        Args:</span>
<span class="sd">            t_arrays (ndarray): Transformed time index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span> <span class="o">=</span> <span class="n">ChangepointMatrix</span><span class="p">(</span>
            <span class="n">to_list_if_scalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changepoint_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_series</span><span class="p">),</span>
            <span class="n">changepoint_range</span><span class="o">=</span><span class="n">to_list_if_scalar</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_range</span> <span class="ow">or</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">changepoint_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_series</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_scaled</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_changepoint_prior_vectors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n_changepoint_per_series</span><span class="p">,</span> <span class="n">changepoint_prior_scale</span><span class="p">,</span> <span class="n">n_series</span><span class="p">,</span> <span class="n">global_rates</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the prior vectors for changepoint distribution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">zeros_with_first_value</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">first_value</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">first_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span>

        <span class="n">changepoint_prior_scale_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_changepoint</span><span class="p">)</span> <span class="o">*</span> <span class="n">cur_changepoint_prior_scale</span>
                <span class="k">for</span> <span class="n">n_changepoint</span><span class="p">,</span> <span class="n">cur_changepoint_prior_scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">n_changepoint_per_series</span><span class="p">,</span>
                    <span class="n">to_list_if_scalar</span><span class="p">(</span><span class="n">changepoint_prior_scale</span><span class="p">,</span> <span class="n">n_series</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">changepoint_prior_loc_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">zeros_with_first_value</span><span class="p">(</span><span class="n">n_changepoint</span><span class="p">,</span> <span class="n">estimated_global_rate</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n_changepoint</span><span class="p">,</span> <span class="n">estimated_global_rate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">n_changepoint_per_series</span><span class="p">,</span> <span class="n">global_rates</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">changepoint_prior_loc_vector</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">changepoint_prior_scale_vector</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_trend_prior_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_arrays</span><span class="p">,</span> <span class="n">y_arrays</span><span class="p">):</span>

        <span class="n">distributions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">global_rates</span> <span class="o">=</span> <span class="n">enforce_array_if_zero_dim</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_t</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_t</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span>
            <span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="o">-</span> <span class="n">global_rates</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_t</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span>

            <span class="n">distributions</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
                <span class="n">offset</span><span class="p">,</span>                
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changepoint_prior_scale</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">==</span> <span class="s2">&quot;logistic&quot;</span><span class="p">:</span>

            <span class="n">global_rates</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">suggest_logistic_rate_and_offset</span><span class="p">(</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t_arrays</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y_arrays</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                <span class="n">capacities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_capacity_prior_loc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">global_rates</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span>

            <span class="n">distributions</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_capacity_prior_loc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_capacity_prior_scale</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">distributions</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span>
                <span class="n">offset</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="n">y_arrays</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="o">-</span> <span class="n">y_arrays</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Trend</span>

        <span class="c1"># Changepoints and trend-related distributions</span>
        <span class="n">changepoint_prior_loc_vector</span><span class="p">,</span> <span class="n">changepoint_prior_scale_vector</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_changepoint_prior_vectors</span><span class="p">(</span>
                <span class="n">n_changepoint_per_series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_changepoint_per_series</span><span class="p">,</span>
                <span class="n">changepoint_prior_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">changepoint_prior_scale</span><span class="p">,</span>
                <span class="n">n_series</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_series</span><span class="p">,</span>
                <span class="n">global_rates</span><span class="o">=</span><span class="n">global_rates</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">distributions</span><span class="p">[</span><span class="s2">&quot;changepoints_coefficients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Laplace</span><span class="p">(</span>
            <span class="n">changepoint_prior_loc_vector</span><span class="p">,</span> <span class="n">changepoint_prior_scale_vector</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">distributions</span>

    <span class="k">def</span> <span class="nf">_set_prior_distributions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t_arrays</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y_arrays</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the prior distributions.</span>

<span class="sd">        Args:</span>
<span class="sd">            t_arrays (jnp.ndarray): The array of time values.</span>
<span class="sd">            y_arrays (jnp.ndarray): The array of target values.</span>
<span class="sd">            X (pd.DataFrame): The dataframe of exogenous variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">distributions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Trend</span>
        <span class="n">distributions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_trend_prior_distributions</span><span class="p">(</span><span class="n">t_arrays</span><span class="p">,</span> <span class="n">y_arrays</span><span class="p">))</span>

        <span class="c1"># Exog variables</span>
        <span class="n">exogenous_distributions</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span><span class="p">:</span>
            <span class="c1"># The dict self.exogenous_prior contain a regex as key, and a tuple (distribution, kwargs) as value.</span>
            <span class="c1"># The regex is matched against the column names of X, and the corresponding distribution is used to</span>

            <span class="n">exogenous_distributions</span><span class="p">,</span> <span class="n">exogenous_permutation_matrix</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">get_exogenous_priors</span><span class="p">(</span>
                    <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogenous_priors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_exogenous_prior</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">distributions</span><span class="p">[</span><span class="s2">&quot;exogenous_coefficients&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">exogenous_distributions</span><span class="p">)</span>
            <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;exogenous_permutation_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exogenous_permutation_matrix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;exogenous_permutation_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># distributions[&quot;exogenous_coefficients&quot;] = None</span>

        <span class="c1"># Noise</span>
        <span class="n">distributions</span><span class="p">[</span><span class="s2">&quot;std_observation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">HalfNormal</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noise_scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span>
        <span class="p">)</span>

        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;distributions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributions</span>

        <span class="k">return</span> <span class="n">inputs</span>

    <span class="k">def</span> <span class="nf">predict_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fh</span><span class="p">:</span> <span class="n">ForecastingHorizon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate samples for the given exogenous variables and forecasting horizon.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (pd.DataFrame): Exogenous variables.</span>
<span class="sd">            fh (ForecastingHorizon): Forecasting horizon.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Predicted samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">predict_samples</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">get_multiindex_loc</span><span class="p">(</span>
            <span class="n">samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_y_indexes_</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_predict_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fh</span><span class="p">:</span> <span class="n">ForecastingHorizon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate samples for the given exogenous variables and forecasting horizon.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (pd.DataFrame): Exogenous variables.</span>
<span class="sd">            fh (ForecastingHorizon): Forecasting horizon.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Predicted samples.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fh_dates</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">to_absolute</span><span class="p">(</span>
            <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">full_y_indexes_</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">fh_as_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fh_dates</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Create an empty X if the model has transformer and X is None</span>
            <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">reindex_time_series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span> <span class="n">fh_as_index</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ForecastingHorizon</span><span class="p">):</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_fh</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

        <span class="n">t_arrays</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">convert_index_to_days_since_epoch</span><span class="p">(</span><span class="n">fh_as_index</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">t_arrays</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">t_arrays</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_series</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">t_arrays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">t_arrays</span><span class="p">)</span>

        <span class="n">changepoints_matrix</span><span class="p">,</span> <span class="n">changepoints_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_arrays</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fh_as_index</span><span class="p">)]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_columns_transformer_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">exogenous_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_exogenous_matrix_from_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exogenous_matrix</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t_arrays</span><span class="p">)</span>

        <span class="n">predictive</span> <span class="o">=</span> <span class="n">Predictive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">posterior_samples_</span><span class="p">,</span>
            <span class="n">return_sites</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">site_names</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">extra_inputs_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_inputs_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">extra_inputs_</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;changepoints_matrix&quot;</span><span class="p">:</span> <span class="n">changepoints_matrix</span><span class="p">,</span>
                <span class="s2">&quot;changepoints_mask&quot;</span><span class="p">:</span> <span class="n">changepoints_mask</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">predictive</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t_arrays</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">exogenous_matrix</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_inputs_</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_exogenous_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the prior distributions for the exogenous variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (pd.DataFrame): Exogenous variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The dict self.exogenous_prior contain a regex as key, and a tuple (distribution, kwargs) as value.</span>
        <span class="c1"># The regex is matched against the column names of X, and the corresponding distribution is used to</span>

        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exogenous_dists</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exogenous_permutation_matrix</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">get_exogenous_priors</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogenous_priors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_exogenous_prior</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_changepoint_per_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of changepoints per series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of changepoints per series.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span><span class="o">.</span><span class="n">n_changepoint_per_series</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_series</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Number of series.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.n_changepoint_per_series" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">n_changepoint_per_series</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get the number of changepoints per series.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of changepoints per series.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.n_series" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">n_series</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>Get the number of series.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>int</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Number of series.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>
  </div>

</div>




<div class="doc doc-object doc-function">



<h3 id="hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">changepoint_interval</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">changepoint_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exogenous_priors</span><span class="o">=</span><span class="p">{},</span> <span class="n">default_exogenous_prior</span><span class="o">=</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">changepoint_prior_scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">capacity_prior_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">capacity_prior_loc</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">y_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">seasonality_mode</span><span class="o">=</span><span class="s1">&#39;multiplicative&#39;</span><span class="p">,</span> <span class="n">transformer_pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">individual_regressors</span><span class="o">=</span><span class="p">[],</span> <span class="n">mcmc_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">mcmc_warmup</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mcmc_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the HierarchicalProphet forecaster.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>changepoint_interval</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The interval between potential changepoints in the time series. Defaults to 25.</p>
            </div>
          </td>
          <td>
                <code>25</code>
          </td>
        </tr>
        <tr>
          <td><code>changepoint_range</code></td>
          <td>
                <code>float or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The index of the last changepoint. If None, default to -changepoint_freq. Note that this is the index in the list of timestamps, and because the timeseries increases in size, it is better to use negative indexes instead of positive. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>exogenous_priors</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of prior distributions for the exogenous variables. The keys are regexes, or the name of an specific column, and the values are tuples of the format (dist.Distribution, *args). The args are passed to dist.Distributions at the moment of sampling. Defaults to {}.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
        <tr>
          <td><code>default_exogenous_prior</code></td>
          <td>
                <code>tuple</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The default prior distribution for the exogenous variables. Defaults to (dist.Normal, 0, 1), and is applied to columns not included in exogenous_priors above.</p>
            </div>
          </td>
          <td>
                <code>(<span title="numpyro.distributions.Normal">Normal</span>, 0, 1)</code>
          </td>
        </tr>
        <tr>
          <td><code>changepoint_prior_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scale parameter for the prior distribution of changepoints. Defaults to 0.1. Note that this parameter is scaled by the magnitude of the timeseries.</p>
            </div>
          </td>
          <td>
                <code>0.1</code>
          </td>
        </tr>
        <tr>
          <td><code>capacity_prior_loc</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The location parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 1.1, i.e., 110% of the maximum value of the series, or the y_scales if provided.</p>
            </div>
          </td>
          <td>
                <code>1.1</code>
          </td>
        </tr>
        <tr>
          <td><code>capacity_prior_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scale parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 0.2.</p>
            </div>
          </td>
          <td>
                <code>0.2</code>
          </td>
        </tr>
        <tr>
          <td><code>y_scales</code></td>
          <td>
                <code>array - like or None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scales of the target time series. Defaults to None. If not provided, the scales are computed from the data, according to its maximum value.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>noise_scale</code></td>
          <td>
                <code>float</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The scale parameter for the prior distribution of observation noise. Defaults to 0.05.</p>
            </div>
          </td>
          <td>
                <code>0.05</code>
          </td>
        </tr>
        <tr>
          <td><code>trend</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The type of trend to model. Possible values are "linear" and "logistic". Defaults to "linear".</p>
            </div>
          </td>
          <td>
                <code>&#39;linear&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>seasonality_mode</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The mode of seasonality to model. Possible values are "multiplicative" and "additive". Defaults to "multiplicative".</p>
            </div>
          </td>
          <td>
                <code>&#39;multiplicative&#39;</code>
          </td>
        </tr>
        <tr>
          <td><code>transformer_pipeline</code></td>
          <td>
                <code><span title="sktime.transformations.base.BaseTransformer">BaseTransformer</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A BaseTransformer or TransformerPipeline from sktime to apply to X and create features internally, such as Fourier series. See sktime's Transformer documentation for more information. Defaults to None.</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr>
          <td><code>individual_regressors</code></td>
          <td>
                <code>list</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of regexes/names of individual regressors to separate by timeseries. If not provided, all regressors are shared. Defaults to [].</p>
            </div>
          </td>
          <td>
                <code>[]</code>
          </td>
        </tr>
        <tr>
          <td><code>mcmc_samples</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of MCMC samples to draw. Defaults to 2000.</p>
            </div>
          </td>
          <td>
                <code>2000</code>
          </td>
        </tr>
        <tr>
          <td><code>mcmc_warmup</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of MCMC warmup steps. Defaults to 200.</p>
            </div>
          </td>
          <td>
                <code>200</code>
          </td>
        </tr>
        <tr>
          <td><code>mcmc_chains</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of MCMC chains to run in parallel. Defaults to 4.</p>
            </div>
          </td>
          <td>
                <code>4</code>
          </td>
        </tr>
        <tr>
          <td><code>rng_key</code></td>
          <td>
                <code><span title="jax.random.PRNGKey">PRNGKey</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The random number generator key. Defaults to random.PRNGKey(24).</p>
            </div>
          </td>
          <td>
                <code><span title="jax.random.PRNGKey">PRNGKey</span>(24)</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">changepoint_interval</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">changepoint_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">exogenous_priors</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">default_exogenous_prior</span><span class="o">=</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">changepoint_prior_scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">capacity_prior_scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">capacity_prior_loc</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span>
    <span class="n">y_scales</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">noise_scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">seasonality_mode</span><span class="o">=</span><span class="s2">&quot;multiplicative&quot;</span><span class="p">,</span>
    <span class="n">transformer_pipeline</span><span class="p">:</span> <span class="n">BaseTransformer</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">individual_regressors</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">mcmc_samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">mcmc_warmup</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">mcmc_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the HierarchicalProphet forecaster.</span>

<span class="sd">    Args:</span>
<span class="sd">        changepoint_interval (int, optional): The interval between potential changepoints in the time series. Defaults to 25.</span>
<span class="sd">        changepoint_range (float or None, optional): The index of the last changepoint. If None, default to -changepoint_freq. Note that this is the index in the list of timestamps, and because the timeseries increases in size, it is better to use negative indexes instead of positive. Defaults to None.</span>
<span class="sd">        exogenous_priors (dict, optional): A dictionary of prior distributions for the exogenous variables. The keys are regexes, or the name of an specific column, and the values are tuples of the format (dist.Distribution, *args). The args are passed to dist.Distributions at the moment of sampling. Defaults to {}.</span>
<span class="sd">        default_exogenous_prior (tuple, optional): The default prior distribution for the exogenous variables. Defaults to (dist.Normal, 0, 1), and is applied to columns not included in exogenous_priors above.</span>
<span class="sd">        changepoint_prior_scale (float, optional): The scale parameter for the prior distribution of changepoints. Defaults to 0.1. Note that this parameter is scaled by the magnitude of the timeseries.</span>
<span class="sd">        capacity_prior_loc (float, optional): The location parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 1.1, i.e., 110% of the maximum value of the series, or the y_scales if provided.</span>
<span class="sd">        capacity_prior_scale (float, optional): The scale parameter for the prior distribution of capacity. This parameter is scaled according to y_scales. Defaults to 0.2.</span>
<span class="sd">        y_scales (array-like or None, optional): The scales of the target time series. Defaults to None. If not provided, the scales are computed from the data, according to its maximum value.</span>
<span class="sd">        noise_scale (float, optional): The scale parameter for the prior distribution of observation noise. Defaults to 0.05.</span>
<span class="sd">        trend (str, optional): The type of trend to model. Possible values are &quot;linear&quot; and &quot;logistic&quot;. Defaults to &quot;linear&quot;.</span>
<span class="sd">        seasonality_mode (str, optional): The mode of seasonality to model. Possible values are &quot;multiplicative&quot; and &quot;additive&quot;. Defaults to &quot;multiplicative&quot;.</span>
<span class="sd">        transformer_pipeline (BaseTransformer): A BaseTransformer or TransformerPipeline from sktime to apply to X and create features internally, such as Fourier series. See sktime&#39;s Transformer documentation for more information. Defaults to None.</span>
<span class="sd">        individual_regressors (list, optional): A list of regexes/names of individual regressors to separate by timeseries. If not provided, all regressors are shared. Defaults to [].</span>
<span class="sd">        mcmc_samples (int, optional): The number of MCMC samples to draw. Defaults to 2000.</span>
<span class="sd">        mcmc_warmup (int, optional): The number of MCMC warmup steps. Defaults to 200.</span>
<span class="sd">        mcmc_chains (int, optional): The number of MCMC chains to run in parallel. Defaults to 4.</span>
<span class="sd">        rng_key (jax.random.PRNGKey, optional): The random number generator key. Defaults to random.PRNGKey(24).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_interval</span> <span class="o">=</span> <span class="n">changepoint_interval</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_range</span> <span class="o">=</span> <span class="n">changepoint_range</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">changepoint_prior_scale</span> <span class="o">=</span> <span class="n">changepoint_prior_scale</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">noise_scale</span> <span class="o">=</span> <span class="n">noise_scale</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_scale</span> <span class="o">=</span> <span class="n">capacity_prior_scale</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">capacity_prior_loc</span> <span class="o">=</span> <span class="n">capacity_prior_loc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">y_scales</span> <span class="o">=</span> <span class="n">y_scales</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">seasonality_mode</span> <span class="o">=</span> <span class="n">seasonality_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">trend</span> <span class="o">=</span> <span class="n">trend</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">exogenous_priors</span> <span class="o">=</span> <span class="n">exogenous_priors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">default_exogenous_prior</span> <span class="o">=</span> <span class="n">default_exogenous_prior</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">individual_regressors</span> <span class="o">=</span> <span class="n">individual_regressors</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transformer_pipeline</span> <span class="o">=</span> <span class="n">transformer_pipeline</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">rng_key</span><span class="o">=</span><span class="n">rng_key</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;mcmc&quot;</span><span class="p">,</span>
        <span class="n">mcmc_samples</span><span class="o">=</span><span class="n">mcmc_samples</span><span class="p">,</span>
        <span class="n">mcmc_warmup</span><span class="o">=</span><span class="n">mcmc_warmup</span><span class="p">,</span>
        <span class="n">mcmc_chains</span><span class="o">=</span><span class="n">mcmc_chains</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">aggregator_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">original_y_indexes_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">full_y_indexes_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">hierarchy_matrix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_has_exogenous_variables</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expand_columns_transformer_</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_time_scaler</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_t</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_t</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_changepoint_matrix_maker</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_hyperparams</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.get_changepoint_prior_vectors" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_changepoint_prior_vectors</span><span class="p">(</span><span class="n">n_changepoint_per_series</span><span class="p">,</span> <span class="n">changepoint_prior_scale</span><span class="p">,</span> <span class="n">n_series</span><span class="p">,</span> <span class="n">global_rates</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Set the prior vectors for changepoint distribution.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_changepoint_prior_vectors</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">n_changepoint_per_series</span><span class="p">,</span> <span class="n">changepoint_prior_scale</span><span class="p">,</span> <span class="n">n_series</span><span class="p">,</span> <span class="n">global_rates</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the prior vectors for changepoint distribution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">zeros_with_first_value</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">first_value</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">first_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="n">changepoint_prior_scale_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_changepoint</span><span class="p">)</span> <span class="o">*</span> <span class="n">cur_changepoint_prior_scale</span>
            <span class="k">for</span> <span class="n">n_changepoint</span><span class="p">,</span> <span class="n">cur_changepoint_prior_scale</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">n_changepoint_per_series</span><span class="p">,</span>
                <span class="n">to_list_if_scalar</span><span class="p">(</span><span class="n">changepoint_prior_scale</span><span class="p">,</span> <span class="n">n_series</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">changepoint_prior_loc_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">zeros_with_first_value</span><span class="p">(</span><span class="n">n_changepoint</span><span class="p">,</span> <span class="n">estimated_global_rate</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n_changepoint</span><span class="p">,</span> <span class="n">estimated_global_rate</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">n_changepoint_per_series</span><span class="p">,</span> <span class="n">global_rates</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">changepoint_prior_loc_vector</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">changepoint_prior_scale_vector</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="hierarchical_prophet.hierarchical_prophet.prophet.HierarchicalProphet.predict_samples" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">predict_samples</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Generate samples for the given exogenous variables and forecasting horizon.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
                <code><span title="pandas.DataFrame">DataFrame</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Exogenous variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>fh</code></td>
          <td>
                <code><span title="sktime.forecasting.base.ForecastingHorizon">ForecastingHorizon</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Forecasting horizon.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>np.ndarray: Predicted samples.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fh</span><span class="p">:</span> <span class="n">ForecastingHorizon</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate samples for the given exogenous variables and forecasting horizon.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (pd.DataFrame): Exogenous variables.</span>
<span class="sd">        fh (ForecastingHorizon): Forecasting horizon.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Predicted samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">predict_samples</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">get_multiindex_loc</span><span class="p">(</span>
        <span class="n">samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_y_indexes_</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>



<div class="doc doc-object doc-function">



<h2 id="hierarchical_prophet.hierarchical_prophet.prophet.enforce_array_if_zero_dim" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">enforce_array_if_zero_dim</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Reshapes the input array <code>x</code> to have at least one dimension if it has zero dimensions.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code>array - like</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The input array.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>array-like: The reshaped array.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">enforce_array_if_zero_dim</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reshapes the input array `x` to have at least one dimension if it has zero dimensions.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (array-like): The input array.</span>

<span class="sd">    Returns:</span>
<span class="sd">        array-like: The reshaped array.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="hierarchical_prophet.hierarchical_prophet.prophet.model" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">model</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">changepoints_matrix</span><span class="p">,</span> <span class="n">changepoints_mask</span><span class="p">,</span> <span class="n">s_matrix</span><span class="p">,</span> <span class="n">exogenous_permutation_matrix</span><span class="p">,</span> <span class="n">distributions</span><span class="p">,</span> <span class="n">trend_mode</span><span class="p">,</span> <span class="n">seasonality_mode</span><span class="p">,</span> <span class="n">y_scales</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Define the probabilistic model for Prophet2.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>t</code></td>
          <td>
                <code>ndarray</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Time index.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code>ndarray</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Target time series.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>X</code></td>
          <td>
                <code>ndarray</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Exogenous variables.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>changepoints_matrix</code></td>
          <td>
                <code>ndarray</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Changepoint matrix.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>s_matrix</code></td>
          <td>
                <code>ndarray</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Reconciliation matrix.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>args,</code></td>
          <td>
                <code>kwargs</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Additional arguments and keyword arguments for the model.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>None</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>None</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">model</span><span class="p">(</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">changepoints_matrix</span><span class="p">,</span>
    <span class="n">changepoints_mask</span><span class="p">,</span>
    <span class="n">s_matrix</span><span class="p">,</span>
    <span class="n">exogenous_permutation_matrix</span><span class="p">,</span>
    <span class="n">distributions</span><span class="p">,</span>
    <span class="n">trend_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">seasonality_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">y_scales</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the probabilistic model for Prophet2.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (ndarray): Time index.</span>
<span class="sd">        y (ndarray): Target time series.</span>
<span class="sd">        X (ndarray): Exogenous variables.</span>
<span class="sd">        changepoints_matrix (ndarray): Changepoint matrix.</span>
<span class="sd">        s_matrix (ndarray): Reconciliation matrix.</span>
<span class="sd">        args, kwargs: Additional arguments and keyword arguments for the model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">init_params</span><span class="p">(</span><span class="n">distributions</span><span class="o">=</span><span class="n">distributions</span><span class="p">)</span>

    <span class="c1"># Trend</span>

    <span class="n">changepoints_coefficients</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;changepoints_coefficients&quot;</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span>

    <span class="n">trend</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">changepoints_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="n">changepoints_mask</span> <span class="o">*</span> <span class="n">changepoints_coefficients</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trend</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">trend_mode</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">trend</span> <span class="o">*=</span> <span class="n">y_scales</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">trend_mode</span> <span class="o">==</span> <span class="s2">&quot;logistic&quot;</span><span class="p">:</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;capacity&quot;</span><span class="p">]</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">y_scales</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">trend</span><span class="p">))</span>

    <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;trend_&quot;</span><span class="p">,</span> <span class="n">trend</span><span class="p">)</span>

    <span class="c1"># Exogenous variables</span>

    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exogenous_coefficients&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exogenous_coefficients</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;exogenous_coefficients&quot;</span><span class="p">]</span>
        <span class="n">permuted_exogenous</span> <span class="o">=</span> <span class="n">exogenous_permutation_matrix</span> <span class="o">@</span> <span class="n">exogenous_coefficients</span>

        <span class="n">exogenous_effect_decomposition</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="n">permuted_exogenous</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span>
            <span class="s2">&quot;exogenous_effect_decomposition_&quot;</span><span class="p">,</span> <span class="n">exogenous_effect_decomposition</span>
        <span class="p">)</span>
        <span class="n">exogenous_effect</span> <span class="o">=</span> <span class="n">exogenous_effect_decomposition</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">seasonality_mode</span> <span class="o">==</span> <span class="s2">&quot;additive&quot;</span><span class="p">:</span>
            <span class="n">exogenous_effect</span> <span class="o">=</span> <span class="n">exogenous_effect</span> <span class="o">*</span> <span class="n">y_scales</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Mean</span>
        <span class="k">if</span> <span class="n">seasonality_mode</span> <span class="o">==</span> <span class="s2">&quot;additive&quot;</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">additive_mean_model</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">exogenous_effect</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">seasonality_mode</span> <span class="o">==</span> <span class="s2">&quot;multiplicative&quot;</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">multiplicative_mean_model</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">exogenous_effect</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">trend</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

    <span class="n">numpyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s2">&quot;mean_&quot;</span><span class="p">,</span> <span class="n">mean</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mean</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>


    <span class="n">numpyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;obs&quot;</span><span class="p">,</span>
        <span class="n">NormalReconciled</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;std_observation&quot;</span><span class="p">],</span>
            <span class="n">reconc_matrix</span><span class="o">=</span><span class="n">s_matrix</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="hierarchical_prophet.hierarchical_prophet.prophet.to_list_if_scalar" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">to_list_if_scalar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Converts a scalar value to a list of the same value repeated <code>size</code> times.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code>scalar or array - like</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The input value to be converted.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>size</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The number of times to repeat the value in the list. Default is 1.</p>
            </div>
          </td>
          <td>
                <code>1</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
<th>Name</th>        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
<td><code>list</code></td>          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list containing the input value repeated <code>size</code> times if <code>x</code> is a scalar, otherwise returns <code>x</code> unchanged.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/hierarchical_prophet/hierarchical_prophet/prophet.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_list_if_scalar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a scalar value to a list of the same value repeated `size` times.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (scalar or array-like): The input value to be converted.</span>
<span class="sd">        size (int, optional): The number of times to repeat the value in the list. Default is 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list containing the input value repeated `size` times if `x` is a scalar, otherwise returns `x` unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.bd41221c.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>